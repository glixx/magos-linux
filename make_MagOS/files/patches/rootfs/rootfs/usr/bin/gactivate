#!/bin/bash
if [ "$(id -un)" != "root" ] ;then
   gksu -g "/bin/bash $0 $@"
   exit 0
fi

if [ -n "$KDE_SESSION_UID" ] ;then
   MSG='kdialog --msgbox '
   ERR='kdialog --error '
else
   MSG='zenity --info --text='
   ERR='zenity --error --text='
fi

MSG_MOVE="was moved into MagOS/optional"
MSG_NOMOVE="was not moved into MagOS/optional"
MSG_ACT="ACTIVATED"
MSG_ACT_ERR="ERROR while activating module"
MSG_DEACT="DEACTIVATED"
MSG_MOD="module"

if [ "$LANG" = "ru_RU.UTF-8" ] ;then
   MSG_MOVE="перенесен в MagOS/optional"
   MSG_NOMOVE="перенести в MagOS/optional не удалось"
   MSG_ACT="ПОДКЛЮЧЕН"
   MSG_ACT_ERR="ОШИБКА при активации модуля"
   MSG_DEACT="ОТКЛЮЧЕН"
   MSG_MOD="модуль"
fi

for module in $@ ; do
   FILENAME=`echo $module | awk -F/ '{ print $NF }'`
   FULLNAME=$module
   DESNAME=/mnt/livemedia/MagOS/optional/$FILENAME
   MSG1=
   if [ `echo $module | grep -i /tmp` ] ;then
      mv $module $DESNAME
      if [ $? -eq 0 ] ;then
         FULLNAME=$DESNAME
         MSG1="$MSG_MOVE"
      else
         MSG1="$MSG_NOMOVE"
      fi
   fi

   deactivate $FULLNAME
   if [ $? -eq 0 ] ;then
      $MSG" $MSG_MOD $FILENAME $MSG_DEACT"
   else
      activate $FULLNAME 2> /var/log/lzm.log
      if [ $? -ne 0 ] ;then
         ERROR=`cat /var/log/lzm.log`
         $ERR" $MSG_ACT_ERR \n $ERROR"
      else
         $MSG" $MSG_MOD $FILENAME $MSG_ACT \n $MSG1 "
      fi
   fi
done
exit 0
